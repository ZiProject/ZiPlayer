name: Update Documentation on Code Change

on:
  push:
    branches: [main, develop]
    paths:
      - "core/**"
      - "extension/**"
      - "plugins/**"
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTIONS_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: page/package-lock.json

      - name: Install dependencies
        run: |
          cd page
          npm ci

      - name: Generate API Documentation
        run: |
          cd page
          echo "🚀 Generating API documentation..."
          node scripts/simple-build.js

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "📝 Files have been modified:"
            git status --porcelain
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ℹ️  No files were modified"
          fi

      - name: Create commit
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add page/components/GeneratedApiContent.ts
          git commit -m "🤖 Auto-update API documentation

          - Generated from latest JSDoc comments
          - Updated on $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Triggered by changes in: ${{ github.event.head_commit.modified }}"

      - name: Push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git push origin ${{ github.ref_name }}

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true' && github.ref_name != 'main'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.ACTIONS_TOKEN }}
          commit-message: "🤖 Auto-update API documentation"
          title: "🤖 Auto-update API Documentation"
          body: |
            ## 📚 API Documentation Auto-Update

            This PR contains automatically generated API documentation updates.

            ### 🔄 Changes Made:
            - Updated `GeneratedApiContent.ts` with latest API information
            - Generated from JSDoc comments in the codebase
            - Includes methods, events, and examples from recent code changes

            ### 📁 Files Modified:
            - `page/components/GeneratedApiContent.ts`

            ### 🚀 Triggered By:
            - Branch: `${{ github.ref_name }}`
            - Commit: `${{ github.sha }}`
            - Modified files: `${{ github.event.head_commit.modified }}`

            ---
            *This PR was automatically created by the GitHub Action workflow.*
          branch: auto-update-api-docs-${{ github.run_number }}
          delete-branch: true

      - name: Summary
        run: |
          echo "## 📊 Documentation Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.verify-changed-files.outputs.changed == 'true' && '✅ Updated' || 'ℹ️ No changes needed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
            echo "**Files Modified:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`page/components/GeneratedApiContent.ts\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- Review the generated documentation" >> $GITHUB_STEP_SUMMARY
            echo "- Merge the changes if everything looks good" >> $GITHUB_STEP_SUMMARY
          else
            echo "**No changes detected in API documentation.**" >> $GITHUB_STEP_SUMMARY
          fi
