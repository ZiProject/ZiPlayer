name: Scheduled Documentation Update

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  scheduled-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTIONS_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: page/package-lock.json

      - name: Install dependencies
        run: |
          cd page
          npm ci

      - name: Generate API Documentation
        run: |
          cd page
          echo "🕐 Running scheduled API documentation update..."
          node scripts/simple-build.js

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "📝 Files have been modified:"
            git status --porcelain
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ℹ️  No files were modified"
          fi

      - name: Create commit
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add page/components/GeneratedApiContent.ts
          git commit -m "🤖 Scheduled API documentation update

          - Generated from latest JSDoc comments
          - Scheduled update on $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Workflow: ${{ github.workflow }}"

      - name: Push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git push origin main

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.ACTIONS_TOKEN }}
          commit-message: "🤖 Scheduled API documentation update"
          title: "🤖 Scheduled API Documentation Update - $(date -u '+%Y-%m-%d')"
          body: |
            ## 📚 Scheduled API Documentation Update

            This PR contains automatically generated API documentation updates from the scheduled workflow.

            ### 🔄 Changes Made:
            - Updated `GeneratedApiContent.ts` with latest API information
            - Generated from JSDoc comments in the codebase
            - Includes methods, events, and examples

            ### 📁 Files Modified:
            - `page/components/GeneratedApiContent.ts`

            ### ⏰ Schedule:
            - **Triggered:** Scheduled workflow
            - **Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            - **Workflow:** ${{ github.workflow }}

            ---
            *This PR was automatically created by the scheduled GitHub Action workflow.*
          branch: scheduled-docs-update-$(date +%Y%m%d)
          delete-branch: true

      - name: Summary
        run: |
          echo "## 📊 Scheduled Documentation Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.verify-changed-files.outputs.changed == 'true' && '✅ Updated' || 'ℹ️ No changes needed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** Scheduled workflow" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
            echo "**Files Modified:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`page/components/GeneratedApiContent.ts\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- Review the generated documentation" >> $GITHUB_STEP_SUMMARY
            echo "- Merge the changes if everything looks good" >> $GITHUB_STEP_SUMMARY
          else
            echo "**No changes detected in API documentation.**" >> $GITHUB_STEP_SUMMARY
            echo "**Documentation is up to date!**" >> $GITHUB_STEP_SUMMARY
          fi
